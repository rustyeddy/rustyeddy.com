<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/style.css">


<title>Iot Data Aggregation Hub</title>

<script>(function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,
0)))}}var e=a;"undefined"!==typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
for(h=0;h<l.length;h++)c(e,l[h]);var f="set set_once union unset remove delete".split(" ");e.get_group=function(){function a(c){b[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));e.push([d,call2])}}for(var b={},d=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<f.length;c++)a(f[c]);return b};a._i.push([b,d,g])};a.__SV=1.2;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js";d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d)}})(document,window.mixpanel||[]);
mixpanel.init("bc05040913854909c46ba8408397cdb5", {batch_requests: true})</script>


<body><header class="container bg-white">
  <nav class="navbar navbar-expand-lg navbar-light">

    <a class="navbar-brand text-muted text-monospace" href="/"><span claa="h1">rusty eddy:</span></a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <nav class="navbar-nav w-100 justify-content-end">
	<div class="nav w-100">
  	  <a class="nav-link" href="/iot-project-organic-gardener/">IoT &nbsp</a>
  	  <a class="nav-link" href="/resume"> resume &nbsp</a> 
  	  <a class="nav-link" href="/about"> about &nbsp</a> 
	</div>
      </nav>
    </div>
  </nav>
</header>
<div class="jumbotron border-top border-bottom bg-white" >
    <div class="row">
	<div class="col-md"></div>
	<div class="col-md-8">
	  <h1 class="header h2 text-center pb-1">Iot Data Aggregation Hub</h1>
	    <p class="leadin align-right text-muted text-center mt-0">
		The IoT Hub is the center piece of the OG system it aggregates environmental measurements from MQTT data channels, provides an HTTP  server for the REST API and serves up the responsive Dashboard Webapp. The Hub is also responsible for running the application logic and ensuring data is archived as required. This page we discuss how the Hub is constructed as a MicroService.

	    </p>
	</div>
	<div class="col-md"></div>
    </div>
    <div class="row text-center smaller-text">
	<div class="col"></div>
	<div class="col-8">
	    <nav class="nav justify-content-center">
                
                
                
                
                

	    </nav>

	</div>
	<div class="col"></div>
    </div>
</div>
<div id="main body">
<div class="container">

  <div class="row mb-4">
    <div class="col"></div>
    <div class="col-8">
      <article class="article text-big">
	<h2 id="what-does-og-hub-do">What Does OG Hub Do?</h2>
<p>In a nutshell the <em>OG Hub</em> gathers data from MQTT then makes that data
available to programs and humans via a REST API and Dashboard
served from a builtin HTTP server.  You can call this tiny, fast
program a <a href="https://en.wikipedia.org/wiki/Microservices"><em>Micro-Service</em></a>.</p>
<blockquote>
<p>As matter of fact, it is so small and fast, it is more than happy to
run on a <em>Raspberry Pi</em>!</p>
</blockquote>
<p>The <em>1st Milestone</em> of the
<a href="/iot-project-organic-gardener"><em>Organic Gardener IoT Project</em></a>
is complete. The list of supported features are:</p>
<ol>
<li>Collect environmental Data via MQTT and save in RAM</li>
<li>HTTP server to provide a REST API</li>
<li>HTTP server to serve the <a href="/iot-project-organic-gardener/dashboard">Dashboard</a> webapp</li>
<li>HTTP server enhanced with Websockets to stream data live</li>
</ol>
<p>In a future phase of the project we will add the option of saving
the data in a persistent Data Store (DS) such as a Time Series
database. It will be a future task to select a database or databases
the program will be able to use.</p>
<h3 id="how-does-hub-work">How Does Hub Work?</h3>
<p>The Hub uses the well known and supported <a href="https://mqtt.org">MQTT</a>
light weight messaging protocol to gather data published by a network of
<a href="/iot-project-ogranic-gardener/collection-station">Collection Stations</a>
MQTT uses the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">Pub/Sub</a>
Messaging Model.</p>
<p>Publishers send data to <em>Topics</em> while subscribers subscribe to the
topic and subsequently recieve the corresponding data.  For example a
<em>CS</em> with the ID 10.11.11.22 will publish the current temperature in
fahrenheit with this <em>topic</em>.</p>
<pre tabindex="0"><code>ss/data/10.11.11.2/tempf
</code></pre><p>In this <em>10.11.11.22</em> is the StationID and and <em>tempf</em> is the
SensorID.</p>
<blockquote>
<p><strong>TODO</strong> Write MQTT briefing</p>
</blockquote>
<h4 id="mqtt-wildcard-subscriptions">MQTT Wildcard Subscriptions</h4>
<p>MQTT supports wildcard subscriptions allowing the Hub to subscribe to
<em>ALL</em> <em>data channels</em> even without knowing the stationID&rsquo;s or
sensorIDs before hand.</p>
<p>By subscribing to <code>/ss/data/+/+</code> the Hub will recieve data from
every station and sensor on the network.</p>
<p>When data <em>periodically</em> arrives, the Hub will quickly extract
the following elements of the data point.</p>
<ul>
<li><strong>Station ID</strong> probably in the form of an IP or MAC address</li>
<li><strong>Sensor data</strong> name such as: temprature, humidiy, air-pressure, etc</li>
<li><strong>Value</strong> this will either be an integer or a float64</li>
<li><strong>Timestamp</strong> when the data was sampled.</li>
</ul>
<p>The data is reformatted and stored efficiently in RAM. Let&rsquo;s have a
look at what happens after data is accepted and parsed by the Hub.</p>
<h2 id="in-memory-data-model">In Memory Data Model</h2>
<p>A light weight and efficient message is created from a
combination of the <em>StationID</em> and <em>SensorID</em> elements of the MQTT
topic. Combined with the <em>Value</em> and <em>Timestamp</em> we are able to
construct the following <em>Message</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Msg</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Station</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Sensor</span>  <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Value</span>   <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is a <em>normalized</em> and <em>complete</em> representation of a single <em>data
point</em> at a specific <em>time</em> indexed by the respective <em>station</em> and
<em>sensor</em>.</p>
<h2 id="data-consumers-and-concurrency">Data Consumers and Concurrency</h2>
<p>Every subscriber has a <em>list of Consumers</em> where the <em>Consumer</em>
actually reads the incoming data and applies some <em>applicaiton logic</em>
to that data. For example, soil moisture level of 10% might cause the
consumer to send <em>on</em> command to the sprinkler responsible for
watering that soil.</p>
<p>The tricky part is supporting more than one consumer of this data
stream. For example, we almost always have the in memory cache
running reading incoming data then giving it a time stamp and indexing
for API reference.</p>
<p>Additionally, every dashboard user will require a copy of the current
data in real-time over a websocket.  At any given time, there may be 0
1 or more consumers.</p>
<h3 id="consumer-interface">Consumer Interface</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">GetID</span>()     <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">GetRecvQ</span>()  <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">Msg</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Listen</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Where <em>GetID()</em> helps identify exactly what consumer we
have. <em>RecvQ()</em> will produce a <code>chan Msg</code> that will deliver data
<em>Msgs&rsquo;</em> to a loop in the <em>Listen()</em> function.</p>
<h3 id="consumers-will-come-and-go">Consumers will come and Go</h3>
<p>Due to the fact that <em>Web sockets</em> are built on TCP/IP a client is
required to transmit data. At times there may be <em>no consumers</em>, at
other times there maybe two or more.</p>
<p>In the event of no consumers for the data, the hub must be prepared to
quickly discard the data.</p>
<p>Most likely the <em>memory</em> consumer will always be listening to incoming
data, reformatting it to the indexed version of the data for easy
station recovery. If so, the hub will most likely always have at least
one consumer for the data.</p>
<h2 id="websocket-consumers">Websocket Consumers</h2>
<p>Websocket consumers on the other hand will come and go. A new connection
will establish a <em>websocket</em> connection via TCP/IP to recieve data for
the duration of that conneciton.</p>
<p>When the <em>websocket</em> connection is closed or dropped, the websocket
<em>Consumer</em>  will be removed from the <em>Data Subscription</em>.</p>
<h4 id="multiple-websocket-client">Multiple Websocket Client</h4>
<p>It is quite possible for more than one connection to be established
from different clients. We would like to permit at least <em>Read only</em>
copies of the data over the websocket connection.</p>
<h2 id="volatile-memory-storage">Volatile Memory Storage</h2>
<p>The data as it is gathered is converted into different in memory
structures index first on the Station and then by a Sensor, where each
sensor has a <em>time series</em> (stream of values and successive times).</p>
<p>At anytime an active hub will have an in memory representation of the
timeseires data that abstractly looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ae81ff">station1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">tempf</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn}</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">humidity</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn}</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ae81ff">station2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">tempf</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn}</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">humidity</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn} </span>
</span></span></code></pre></div><h2 id="global-api">Global API</h2>
<p>The Hub provides a REST API allowing other programs to access datasets
from the Hub for various applications. Some of the important REST API
<em>endpoints</em> are:</p>
<ul>
<li>GET       /stations</li>
<li>GET       /station/{stationid}</li>
<li>GET       /data?stationid={stid}&amp;sensor={sens}&amp;start={start}&amp;end={end}</li>
<li>DELETE    /data?stationid={stid}&amp;sensor={sens}&amp;start={start}&amp;end={end}</li>
</ul>
<p>The first two gather and reply with <em>IoT Collection Station</em> meta
data, such as the station ID, sensors hosted and performance
and metrics.</p>
<p>The <code>/data </code> endpoint will return data ;-), filters can be used to
limit the response to certain <em>stations</em>, <em>sensors</em> and / timespans.</p>
<h3 id="go-and-micro-services">Go and Micro Services</h3>
<p>The programming language <em>Go</em> was is a perfect fit for micro-services!
Very fast, small syntax and lot&rsquo;s of built in system level support for
protocols, marshaling, data structures and concurrant programming
support allow us to build a nice compact little IoT server.</p>
<p>We will get into the structure of the Micro-services and how Go helps
us build robust, fast and stable system you expect from <em>&ldquo;Industrial
Strength&rdquo;</em> software written with C/C++ or Java.</p>
<p>If you are not familiar with go and write backend services, system
tools, distributed control systems or command utilities the <em>Hub</em> is a
great place to start!</p>
<h2 id="web-server--webapp">Web Server / Webapp</h2>
<p>The hub is also capable of serving up a webapp providing human
consumption for gathered data. This modern <em>mobile first</em> web app is
discussed at length on this page <a href="/iot-project-sensor-station/dashboard">dashboard</a></p>
<blockquote>
<p>Todo: put a nice pic with a link to the webapp.</p>
</blockquote>
<h2 id="persistence-local-and-global">Persistence Local and Global</h2>
<p>We will save data for future use, the <em>nerdy</em> sounding term for this
is <em>persitence</em> other people may say <em>store</em> or <em>save</em> data.</p>
<p>The data is typically stored in memory, that memory or the live
incoming data can be <em>persisted</em> <em>locally</em> or in the cloud.</p>
<p>Write data from memory to file storage. For this we will use the
JSON formatted files written to local disk, if we have one.</p>
<p>Write data periodically to the Cloud for global accessl.</p>
<h3 id="storage-strategy">Storage Strategy</h3>
<ul>
<li>How much / long to keep data in memory</li>
<li>How much / long to keep data on disk</li>
<li>How long to keep data in cloud</li>
</ul>
<p>Need to have a data persistence strategy.</p>
<h2 id="next-steps">Next Steps</h2>
<p>Where to now?</p>

      </article>
    </div>
    <div class="col"></div>
  </div>

</div>

<div class="container">
  <div class="row">
    
  </div> 

</div>



	</div><footer id="footer" class="container-fluid footer small-text pt-4 border-top">
  <section class="row">
    <div class="col"></div>
    <div class="col text-right">
      <div class="address">419 Main St. #439</div>
      <div class="city">Huntington Beach, CA. 92648</div>
    </div>
    <div class="col-3 text-center">
      <div>
        Last update ~
        
	
        Thursday, Jan 13, 2022
	
        
      </div>
      <div>site by <a href="/">Eddy Consulting, LLC.</a> ~ &#xA9; 2008 to 2020 </div>
    </div>
    <div class="col">
      <div class="text-left">
	<div class="phone">(714) 362-5402</div>
	<a href="https://github.com/rustyeddy">github</a> .
	<a href="https://twitter.com/rustyeddy">twitter</a> .
	<a href="https://linkedin.com/rustyeddy">linkedin</a><br/>	    
      </div>
    </div>
    <div class="col"></div>
  </section>
</footer>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-19940083-13"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-19940083-13');
</script>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>




    </body>
</html>
