<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/style.css">


<title>IoT Project Hub</title>

<script>(function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,
0)))}}var e=a;"undefined"!==typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
for(h=0;h<l.length;h++)c(e,l[h]);var f="set set_once union unset remove delete".split(" ");e.get_group=function(){function a(c){b[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));e.push([d,call2])}}for(var b={},d=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<f.length;c++)a(f[c]);return b};a._i.push([b,d,g])};a.__SV=1.2;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js";d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d)}})(document,window.mixpanel||[]);
mixpanel.init("bc05040913854909c46ba8408397cdb5", {batch_requests: true})</script>


<body><header class="container bg-white">
    <nav class="navbar navbar-expand-lg navbar-light">

	<a class="navbar-brand text-muted text-monospace" href="/"><span claa="h1">rusty eddy:</span></a>

	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
	    <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
	    <nav class="navbar-nav w-100 justify-content-end">
		<div class="nav w-100">
  		    <a class="nav-link" href="/iot-project-sensor-station"> sensor station &nbsp </a>
  	            <a class="nav-link" href="/software"> software &nbsp</a> 
  	            <a class="nav-link" href="/resume"> resume &nbsp</a> 
  	            <a class="nav-link" href="/about"> about &nbsp</a> 
		</div>
 	    </nav>
	</div>
    </nav>
</header>
<div class="jumbotron border-top border-bottom bg-white" >
    <div class="row">
	<div class="col-md"></div>
	<div class="col-md-8">
	  <h1 class="header h2 text-center pb-1">IoT Project Hub</h1>
	    <p class="leadin align-right text-muted text-center mt-0">
		The Sensor Hub gathers data from all connected sensors, aggregates the data for real-time and historic display. The also gets your data to the cloud if you have the desire and an Internet connection.

	    </p>
	</div>
	<div class="col-md"></div>
    </div>
    <div class="row text-center smaller-text">
	<div class="col"></div>
	<div class="col-8">
	    <nav class="nav justify-content-center">
                
                
                
                
                

	    </nav>

	</div>
	<div class="col"></div>
    </div>
</div>
<div id="main body">
<div class="container">

    <div class="row mb-4">
	<div class="col"></div>
	<div class="col-8">
	    <article class="article text-big">
		<h2 id="about-iothub">About IoTHub</h2>
<p>The <em>IoT Hub</em> gathers data from a <em>network</em> of sensors that publish
data at regular intervals. The <em>hub</em> aggregates and sorts the data for
for access by clients. The hub will also push the data to the cloud if
desired.</p>
<p>The <em>IoT Hub</em> comes equipped with a builtin WebApp for easy access to
real-time and historic station and sensor <em>time series</em> data.</p>
<h3 id="mqtt-delivers-the-data">MQTT Delivers the Data</h3>
<p>The Hub gathers data via the well known and supported
<a href="https://mqtt.org">MQTT</a> light weight messaging protocol is an ideal
fit for IoT applications.</p>
<p>The hub gathers data by <em>subscribing</em> to MQTT <em>channels</em> or <em>topics</em>
that each have data periodically <em>published</em> by connected data
sources which typically are
<a href="sensors/wireless-sensors">battery powered wireless sensors</a>.</p>
<p>The topics data sources <em>publish</em> data to have the following format:</p>
<ul>
<li>/ss/data/{stationid}/tepmf</li>
<li>/ss/data/{stationid}/humidity</li>
<li>/ss/data/{stationid}/moisture</li>
</ul>
<p>As you can see, the channels or <em>topics</em> have a specific structure
allowing the <em>IoTHub</em> to parse messages into an <em>internal</em> structure
called a <!-- raw HTML omitted --><em>Msg</em><!-- raw HTML omitted --> that contains these four pieces of
information:</p>
<ul>
<li>Station ID probably in the form of an IP or MAC address</li>
<li>Sensor data name such as: temprature, humidiy, air-pressure, etc</li>
<li>Value: this will either be an integer or a float64</li>
</ul>
<h3 id="mqtt-example">MQTT Example</h3>
<p>For example an IoT station with the ID <em>1.1.2.1</em> will start
<em>publishing</em> temprature data via MQTT on the following path. The rate
the data is published is up to the application.  MQTT will just make
sure the data is reliably delivered to <em>all subscribers</em>, including
our IoTHub.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/ss/data/1.1.2.1/tempf
</code></pre></div><p>The actual <em>data</em> transmitted via the MQTT channel is simply the
temperature in <em>farenhiet</em>. For example, if you have two stations
<em>station1</em> and <em>station2</em> that published fahernheit and a percentage
for temprature and humidity respectively.</p>
<p>You might see something like this:</p>
<blockquote>
<ul>
<li>/ss/data/station1/tempf: 75.5</li>
<li>/ss/data/station1/humidity: 12.5</li>
<li>/ss/data/station2/tempf: 87.7</li>
<li>/ss/data/station2/humidity: 10.2</li>
</ul>
</blockquote>
<h2 id="in-memory-data-model">In Memory Data Model</h2>
<p>A simple light weight and efficient message is created from a
combination of the <em>StationID</em> and <em>SensorID</em> elements of the MQTT
topic. Combined with the <em>Value</em> and <em>Timestamp</em> we are able to
construct the following <em>Message</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Msg</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Station</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Sensor</span>  <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Value</span>   <span style="color:#66d9ef">float64</span>
    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
}
</code></pre></div><p>This is a <em>normalized</em> and <em>complete</em> representation of a single data
<em>value</em> at a specific <em>time</em> indexed with the respective <em>station</em> and
<em>sensor</em>.</p>
<p>This format can be converted in any alternative format required quite
easily and be transported through the system with little overhead. For
example, most operations with 32bits of accuracy can be efficienty
stored in a <em>small</em> <em>fixed size</em> datastructre.</p>
<p>With an IP address of 32bits, most messages can be stored in two 64bit
integers! The standard unix timestamp <!-- raw HTML omitted -->time_t<!-- raw HTML omitted --> is a 32bit
int that has better than one second of accuracy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Msg</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Station</span> <span style="color:#66d9ef">int32</span>
    <span style="color:#a6e22e">Sensor</span>  <span style="color:#66d9ef">int32</span>
    <span style="color:#a6e22e">Value</span>   <span style="color:#66d9ef">int32</span>
    <span style="color:#a6e22e">Time</span>    <span style="color:#66d9ef">int32</span>
}
</code></pre></div><h2 id="data-consumers-and-go-channels">Data Consumers and Go Channels</h2>
<p>Every subscriber has a <em>list of Consumers</em> were <em>Consumers</em> actually
consume the data the MQTT channels produce. The tricky part here is
that we may have more than one consumer of the data.</p>
<p>For example, we have the following consumers:</p>
<ul>
<li>Memory consumer saving new data into historic structures</li>
<li>Web Socket real-time data publisher</li>
</ul>
<h3 id="consumer-requirements">Consumer Requirements</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#a6e22e">GetID</span>()     <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">GetRecvQ</span>()  <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">Msg</span>
    <span style="color:#a6e22e">Listen</span>()
}
</code></pre></div><p>Where <em>GetID()</em> helps identify exactly what consumer we
have. <em>RecvQ()</em> will produce a <code>chan Msg</code> that will deliver data
<em>Msgs'</em> to a loop in the <em>Listen()</em> function.</p>
<h3 id="consumers-will-come-and-go">Consumers will come and Go</h3>
<p>Because of the nature of <em>Web sockets</em> in that you need a client to
transmit data, there are times where it is possibley no <em>consumer</em> for
a particular channels data.  So the Hub was designed to quickly
discard data if there is no consumer for the data.</p>
<p>In practice, most likely the <em>memory</em> or <em>station</em> consumer will
always be listening to incoming data, reformatting it to the indexed
version of the data for easy station recovery.</p>
<p>This will almost always ensure there is at least one <em>consumer</em> for
the data.</p>
<h3 id="websocket-clients">Websocket Clients</h3>
<p>Websocket clients on the other hand will come and go. A new connection
will establish a <em>websocket</em> connection via TCP/IP to recieve data for
the duration of that conneciton.</p>
<p>When the <em>websocket</em> connection is closed or dropped, the websocket
<em>Consumer</em>  will be removed from the <em>Data Subscription</em>.</p>
<h4 id="multiple-websocket-client">Multiple Websocket Client</h4>
<p>It is quite possible for more than one connection to be established
from different clients. We would like to permit at least <em>Read only</em>
copies of the data over the websocket connection.</p>
<h2 id="volatile-memory-storage">Volatile Memory Storage</h2>
<p>The data as it is gathered is converted into different in memory
structures index first on the Station and then by a Sensor, where each
sensor has a <em>time series</em> (stream of values and successive times).</p>
<p>At anytime an active hub will have an in memory representation of the
timeseires data that abstractly looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#ae81ff">station1</span>
  - <span style="color:#f92672">tempf</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn}</span>
  - <span style="color:#f92672">humidity</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn}</span>
- <span style="color:#ae81ff">station2</span>
  - <span style="color:#f92672">tempf</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn}</span>
  - <span style="color:#f92672">humidity</span>: {<span style="color:#ae81ff">t1, v1}, {t2, v2} .. {tn, vn} </span>
</code></pre></div><h2 id="rest-api">REST API</h2>
<p>IoT Hub provides a REST API allowing other programs to access datasets
from the Hub for various applications. Some of the important REST API
<em>endpoints</em> are:</p>
<ul>
<li>GET /stations</li>
<li>GET /station/{stationid}</li>
<li>GET /data/{stationid}/{sensor}/{start}/{end}</li>
<li>DELETE /data/{stationid}/{sensor}/{start}/{end}</li>
</ul>
<p>The first two gather and reply with <em>IoT Station</em> specific meta data,
such as the station ID, sensors it hosts and other performance and
health characteristics.</p>
<h3 id="go-and-micro-services">Go and Micro Services</h3>
<p>The great thing about Go is that it was built out of the box with
great <em>micro-service</em> support. That is, it is very simple to create
say an embedded web server capable of serving up <em>web-pages</em> as well
as a <em>REST</em> interface, <em>GraphQL</em> and <em>Web-sockets</em>.</p>
<blockquote>
<p>TODO example of the go code registering callbacks, handling various
protocols</p>
</blockquote>
<h2 id="web-server--webapp">Web Server / Webapp</h2>
<p>The hub is also capable of serving up a nice modern UI written with
the <em>React</em> or <em>Vue</em> JavaScript framework, which should I choose
..?..</p>
<blockquote>
<p>Todo: put a nice pic with a link to the webapp.</p>
</blockquote>
<p>Are you interested in creating a frontend to the web app, check out my first attempt
here <a href="/sensors/webapp">Web app</a></p>
<h2 id="persistence">Persistence</h2>
<p>We will save data for future use, the <em>nerdy</em> sounding term for this
is <em>persitence</em> other people may say <em>store</em> or <em>save</em> data.</p>
<p>The data is typically stored in memory, that memory or the live
incoming data can be <em>persisted</em> <em>locally</em> or in the cloud.</p>
<h3 id="local">Local</h3>
<p>Write data from memory to file storage. For this we will use the
JSON formatted files written to local disk, if we have one.</p>
<h3 id="cloud">Cloud</h3>
<p>Write data periodically to the Cloud for global accessl.</p>
<h2 id="storage-strategy">Storage Strategy</h2>
<ul>
<li>How much / long to keep data in memory</li>
<li>How much / long to keep data on disk</li>
<li>How long to keep data in cloud</li>
</ul>
<p>Need to have a data persistence strategy.</p>

                <img src="/img/ss-diagram.png" />
	    </article>
	</div>
	<div class="col"></div>
    </div>

</div>

<div class="container">

    

</div>

</div>


	</div><footer id="footer" class="container-fluid footer small-text pt-4 border-top">
    <section class="row">
	<div class="col"></div>
	<div class="col text-right">
	    <div class="address">419 Main St. #439</div>
	    <div class="city">Huntington Beach, CA. 92648</div>
	</div>
	<div class="col-3 text-center">
	    <div>
                Last update ~
                
		
                Thursday, Jan 13, 2022
		
                
            </div>
	    <div>site by <a href="/">Eddy Consulting, LLC.</a> ~ &#xA9; 2008 to 2020 </div>
	</div>
	<div class="col">
	    <div class="text-left">
	        <div class="phone">(714) 362-5402</div>
		<a href="https://github.com/rustyeddy">github</a> .
		<a href="https://twitter.com/rustyeddy">twitter</a> .
		<a href="https://linkedin.com/rustyeddy">linkedin</a><br/>	    
	    </div>
	</div>
	<div class="col"></div>
    </section>
</footer>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-19940083-13', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    </body>
</html>
