<!DOCTYPE html>
<html><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400;1,600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />

  
  <title>Building an IoT Device Manager in Go - Generics, Interfaces and Concurrency</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G7XZRHH62T"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-G7XZRHH62T');
  </script>
</head>
<body><header class="container bg-white">
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">

      <a class="navbar-brand" href="/"><span claa="h1">rusty eddy:</span></a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <nav class="navbar-nav me-auto mb-2 mb-lg-0">
	  <div class="nav-item">
  	    <a class="nav-link" href="/iot/"> iot &nbsp</a>
          </div>
          <div class="nav-item">
  	    <a class="nav-link" href="/software"> software &nbsp</a>
          </div>
          <div class="nav-item">
  	    <a class="nav-link" href="/notes"> notes &nbsp</a>
          </div>
          <div class="nav-item">
  	    <a class="nav-link" href="/resume"> resume &nbsp</a>
          </div>
          <div class="nav-item">
  	    <a class="nav-link" href="/about"> about &nbsp</a>
          </div>
        </nav>
      </div>
    </div>
  </nav>
</header>
<div id="jumbotron" class="jumbotron border-top border-bottom bg-white" >
  <div class="row">
    <div class="col-md"></div>
    <div class="col-md-8 text-center">
      <h1 class="header h2 pb-1">Building an IoT Device Manager in Go - Generics, Interfaces and Concurrency</h1>
      <p class="leadin align-right text-muted text-center mt-0">
        In this article you’ll learn how to build a framework that lets you handle buttons, meters, motors and even full robots from a single Go codebase — real hardware or mocked.

      </p>
    </div>
    <div class="col-md"></div>
  </div>

  <div class="row text-center smaller-text">
    <div class="col"></div>
    <div class="col-8">
      <nav class="nav justify-content-center">
        
        
        
        
        
      </nav>

    </div>
    <div class="col"></div>
  </div>
</div>
<div id="main body">
<div class="container"><div class="row">
    <div class="col"></div>
    <div class="col-md-10 hero-text">
	<article class="article">
	  <h2 id="introduction">Introduction</h2>
<p>Managing IoT devices becomes exponentially more complex as your
network grows. You end up juggling a mix of sensors, actuators, and
communication buses each with its own quirks and challenges.</p>
<p>In the <a href="https://github.com/rustyeddy/otto">OttO Project</a> and companion
<a href="https://github.com/rustyeddy/devices">Devices library</a>, I attempted
to develop a mini framework that would have a clear <em>separation of
concerns</em> between the hardware layer (GPIO, I2C, serial, ADC, PWN,
UART, etc.) and the application layer (messaging, control logic,
logging, deployment, etc).</p>
<p>By creating a clean separation between the HW and application layers
we can focus more on the application layer and simplify the
development of managed IoT applications without necessarily getting
into the weeds of device drivers.  The goal is: a <em>lightweight</em>,
<em>generic</em>, <em>type-safe</em> device system that can manage all kinds of
<em>things</em>, from buttons, meters, motors to full robots.</p>
<p>The software is able to run on top of <em>real hardware</em> e.g. a
<em>Raspberry Pi</em> without modifications as easily as it can run on a laptop
with <em>mocked</em> devices.</p>
<h3 id="the-device-interface-using-go-generics">The Device Interface Using Go Generics</h3>
<p>Here we&rsquo;ll walk through the design of OttO&rsquo;s <em>device manager layer</em>
which sits above the particular devices and their underlying drivers.
The device interface is powered by <a href="https://go.dev/doc/tutorial/generics">Go&rsquo;s
Generics</a> allowing me to write a
single generic interface that supports a multitude of underlying
concrete implementations that either produce or consume virtually any
type of data as well as perform real world activies.</p>
<p>Generics allow us to capture the data-type of the device at compile
time, reducing casting and improving type-safety.</p>
<p>The type of data the device interface supports include primitives
(int, bool, float64, string, etc) as well as complex Go structs.
A few example implementations
<a href="http://github.com/rustyeddy/devices/tree/main/examples">can be found here</a>.</p>
<blockquote>
<p>NOTE: The introduction of <a href="https://go.dev/doc/tutorial/generics">generics to
Go</a> has been controversial as
interfaces or other methods could have worked as well. I choose
generics for this task partially because I wanted to get some
experience with Go&rsquo;s generics.</p>
</blockquote>
<p>Generics allow us to capture the data-type of the device at compile
time, reducing casting and improving type-safety.</p>
<h3 id="mocking-for-development--testing">Mocking for Development &amp; Testing</h3>
<p>This design creates a clear separation between the device and
application layers. As we will see later it also allows application
developers to focus on building the application on a powerful Linux
workstation without any actual hardware via mocking or faking the
underlying hardware, and avoid the inconveniences of working on embedded
systems for much of the application logic.</p>
<p>This enables you to run the same application logic on your laptop,
without messing with GPIO pins or device setup.</p>
<p>Running the same application on <em>real</em> hardware, for example a
<em>Raspberry Pi</em> is as simple as compiling for the target architecture
(e.g. ARM 64) and transfering to that device.</p>
<h2 id="architectural-overview">Architectural Overview</h2>
<p>The idea is simple: each device implements a shared interface <code>With Open(), Close(), Get() and Set()</code>, using the DeviceManager to
coordinate them — whether they’re real hardware or mock hardware
running in memory.</p>
<p>In practice we have two repositories that represent three layers:
<em>drivers</em>, <em>devices</em> and an <em>application framework</em>. The first two
layers can be found in these two repositories
<a href="https://github.com/rustyeddy/devices">devices</a>
the second can be found in
<a href="https://github.com/rustyeddy/otto.">otto</a></p>
<p>One key reason for separating the OttO and Device repositories allows
OttO to be run as an IoT broker only, while other things can be built
to provide that will utilize the underlying hardware.</p>
<h3 id="the-device-layer-with-go-generics">The Device layer with Go Generics</h3>
<p>Device Interface (from devices repo) In devices/device.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">devices</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Device</span>[<span style="color:#a6e22e">T</span> <span style="color:#66d9ef">any</span>] <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ID</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Type</span>() <span style="color:#a6e22e">Type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Open</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Get</span>() (<span style="color:#a6e22e">T</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">v</span> <span style="color:#a6e22e">T</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>That’s it — the entire abstraction layer.</p>
<p>Each device can now expose its own data type, for example:</p>
<ul>
<li>A Button produces a boolean: true/false</li>
<li>A Meter can provide a range of integers: 0–100</li>
<li>Voltage can produce a floatping point value: 12.6V</li>
<li>Environment can produce a multi-valued structure:
<code>{Temp, Humidity, Pressure float64}</code></li>
</ul>
<h3 id="implementing-concrete-devices">Implementing Concrete Devices</h3>
<p>The first example is a simple <em>button</em> device which provides a
<code>Get()</code> method that returns a single <em>boolean</em> type, on/off, true
or false. It does not get much simpler than this.</p>
<p>You can see the full <a href="https://github.com/rustyeddy/devices/blob/main/button/button.go">Button driver implementation here</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">devices</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Example 1: Button (devices/button.go)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Button</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get returns the state of a button either on or off</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Button</span>) <span style="color:#a6e22e">Get</span>() (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">state</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Set is not used on real devices but can be leveraged</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// when mocking</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Button</span>) <span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="a-more-complex-example">A More complex example</h4>
<p>Example two implements a complex type struct consisting of
temperature, humidity and pressure.</p>
<p><a href="https://github.com/rustyeddy/devices/blob/main/bme280/bme280.go">Environmental Sensor</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Env</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Temp</span>, <span style="color:#a6e22e">Humidity</span>, <span style="color:#a6e22e">Pressure</span> <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">EnvSensor</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">Env</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">EnvSensor</span>) <span style="color:#a6e22e">Get</span>() (<span style="color:#a6e22e">Env</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">EnvSensor</span>) <span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">v</span> <span style="color:#a6e22e">Env</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">data</span> = <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><a href="https://github.com/rustyeddy/devices">Full source code on GitHub</a></p>
<p>These examples run natively on a Raspberry Pi with GPIO pins, or via
mock data on just about any Linux distribution, or MAC and maybe even
Windows. It would be fairly easy to port over to other SoC style
boards like the BeagleBone or Nvidia Jetson.</p>
<h3 id="the-drivers">The Drivers</h3>
<p>The driver layer sits closest to the hardware and is agnostic to the
how the data is used by the sensor or actuator that consumes or
produces let alone what the application is doing with the data.</p>
<p>This is the list of drivers currently supported</p>
<ul>
<li>Serial Ports</li>
<li>Digital GPIO</li>
<li>Analog GPIO via the ads1112 i2c chip (on the Raspberry Pi)</li>
<li>i2c</li>
</ul>
<p>This is the list of drivers that will likely be supported sometime in
the near future:</p>
<ul>
<li>SPI</li>
<li>1-wire, etc</li>
<li>Pulse Width Modulation (PWM)</li>
</ul>
<h3 id="the-devices">The Devices</h3>
<p>The devices consist of hardware that uses the underlying drivers, for
example Buttons and LEDs use a single Digital GPIO pin, the GPS device
uses a serial port, while the soil sensor (meter) uses an Analog to
Digital Converter (ADC) made possible by the
<a href="https://www.ti.com/lit/gpn/ADS1112">i2c ads1112</a>
chip.</p>
<p>A major goal of the device layer is to leverage as much good, hard
work from smart people. After all, I don&rsquo;t have the chops or the time
to do all that stuff myself!</p>
<blockquote>
<p>Separation concerns: device drivers from the framework</p>
</blockquote>
<p>In this layer we have been able to leverage a lot of good, hard work
from some really smart people. This was always a primay goal of this
project: was to have the freedom to employ great code from a variety
of great sources.</p>
<h3 id="the-application-framework">The Application Framework</h3>
<p>The heart of the <em>Application Framework</em> is OttO provides a variety of
<em>packages</em> required to manage a fleet of IoT <em>things</em>, or just a
single thing for that matter.  The packages provide these features</p>
<ul>
<li>Data collection and storage</li>
<li>Messanger for <em>pub/sub</em> messaging</li>
<li>HTTP Server provides
<ul>
<li>REST API</li>
<li>Websockets for realtime updates</li>
<li>Standard HTML for Web application Interface</li>
</ul>
</li>
<li>Station package for fleet management</li>
<li>Enhanced Security (Coming Soon)</li>
<li>Well tested</li>
</ul>
<h3 id="the-application">The Application</h3>
<p>There is a reference application known as the <a href="https://github.com/rustyeddy/gardener">The
Gardener</a> an automated
watering station that uses a soil moisture sensor to determine when to
turn a water pump on, as well as light up an LED and update the text
on an OLED display.</p>
<hr>
<p>TODO : Insert architectural drawing here</p>
<hr>
<h2 id="managing-application-devices">Managing Application Devices</h2>
<p>The <em>DeviceManager</em> keeps track of the devices that make up
a <em>thing</em>. It is a registery that organizes a variety devices allowing
the <em>things</em> application to do it&rsquo;s <em>thang</em>.</p>
<p>A simplified version looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">manager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DeviceManager</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Internal generic device store for tests and loose coupling</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">devices</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ManagedDevice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Metrics</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeviceMetrics</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span>      <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span> <span style="color:#e6db74">`json:&#34;-&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewDeviceManager</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">DeviceManager</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">DeviceManager</span>{<span style="color:#a6e22e">devices</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">any</span>)}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetDeviceManager</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">DeviceManager</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">once</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">deviceManager</span> = <span style="color:#a6e22e">NewDeviceManager</span>()
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">deviceManager</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeviceManager</span>) <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">Device</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ManagedDevice</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">md</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewManagedDevice</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Name</span>(), <span style="color:#a6e22e">d</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Name</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">md</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">md</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><a href="https://github.com/rustyeddy/otto/device_manager.go">Full version</a></p>
<h2 id="using-the-device-manager">Using the Device Manager</h2>
<p>In OttO, you can create and register devices dynamically:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">dm</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">manager</span>.<span style="color:#a6e22e">NewDeviceManager</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;on&#34;</span>, <span style="color:#a6e22e">button</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;On&#34;</span>, <span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;off&#34;</span>, <span style="color:#a6e22e">button</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Off&#34;</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;env&#34;</span>, <span style="color:#a6e22e">bme280</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;env&#34;</span>, <span style="color:#e6db74">&#34;/dev/i2c&#34;</span>, <span style="color:#ae81ff">0x76</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Read the environment sensor</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">d</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;env&#34;</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">env</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">Get</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Temp: %.2f°C, Humidity: %.2f%%\n&#34;</span>, <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">Temp</span>, <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">Humidity</span>, <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">Pressure</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="concurrency-and-polling-devices">Concurrency and Polling Devices</h2>
<p>In practice, OttO uses goroutines to read data from many devices at
once — ideal for edge gateways and real-time dashboards.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ManagedDevice wraps any device and adds messaging capabilities</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ManagedDevice</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span>   <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Device</span> <span style="color:#66d9ef">any</span> <span style="color:#75715e">// The underlying device (from devices package)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Topic</span>  <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GenericTimerLoop provides a standard timer loop for any device</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">md</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ManagedDevice</span>) <span style="color:#a6e22e">GenericTimerLoop</span>(<span style="color:#a6e22e">duration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>, <span style="color:#a6e22e">done</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">any</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">duration</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">C</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">ReadPub</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">slog</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Timer loop stopped&#34;</span>, <span style="color:#e6db74">&#34;device&#34;</span>, <span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">pollEnv</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bme280</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;env&#34;</span>, <span style="color:#e6db74">&#34;/dev/i2c&#34;</span>, <span style="color:#ae81ff">0x76</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#e6db74">&#34;env&#34;</span>, <span style="color:#a6e22e">env</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">done</span> <span style="color:#66d9ef">any</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">StartTimerLoop</span>(<span style="color:#ae81ff">15</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">done</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">GenericTimerLoop</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This pattern is already integrated into OttO’s runtime timer based
polling layer for non-blocking updates via Go’s channels.</p>
<h2 id="testing-with-mocks">Testing with Mocks</h2>
<p>The devices and oTTo packages have been designed with mocked
development in mind, allowing focus on application logic and avoiding
the tedium that comes with test full bench setups and prototypes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">mocks</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MockMeter</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">val</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockMeter</span>) <span style="color:#a6e22e">Get</span>() (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">val</span>, <span style="color:#66d9ef">nil</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockMeter</span>) <span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>   { <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">val</span> = <span style="color:#a6e22e">v</span>; <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span> }
</span></span></code></pre></div><p>Mocking lets OttO simulate an entire IoT environment on your laptop —
no physical hardware required.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestMockMeter</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mocks</span>.<span style="color:#a6e22e">MockMeter</span>{<span style="color:#a6e22e">val</span>: <span style="color:#ae81ff">42</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">got</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Get</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">require</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">t</span>, <span style="color:#ae81ff">42</span>, <span style="color:#a6e22e">got</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Using OttO&rsquo;s REST API we can query the configured devices controlled by the
<em>DeviceManager</em>: provided by the <code>/api/devices</code> API endpoint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/api/devices&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">devices</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">List</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">w</span>).<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">devices</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>I started using the <a href="https://github.com/stretchr/testify">testify
package</a>
which makes tests more compact and expressive.</p>
<h2 id="extending-the-system">Extending the System</h2>
<p>With the device manager in place we can now focus on other powerful
features provided by OttO.</p>
<ul>
<li><strong>Persistence</strong>: Save device state via SQLite or BoltDB</li>
<li><strong>Networking</strong>: Expose devices over REST or MQTT</li>
<li><strong>Plugins</strong>: Dynamically load Go modules for new device types</li>
<li><strong>Dashboards</strong>: Visualize data with a web UI or CLI</li>
</ul>
<h2 id="performance-and-deployment">Performance and Deployment</h2>
<p>Go’s lightweight runtime and static binary make it perfect for
IoT application and edge systems:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span>arm64 go build -o otto-arm64
</span></span><span style="display:flex;"><span>scp otto-arm64 pi@raspberrypi.local:/usr/local/bin/
</span></span></code></pre></div><p>You can deploy OttO to:</p>
<ul>
<li>Raspberry Pi or BeagleBone</li>
<li>Linux gateways and routers</li>
<li>Docker containers on ARM or x86</li>
<li>Cloud-based device simulators</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>By combining Go’s generics, interfaces, and goroutines, we’ve built a
foundation that scales from one sensor to an entire IoT network.</p>
<p>The ecosystem now includes:</p>
<ul>
<li><em>Devices</em>: Reusable drivers and interfaces</li>
<li><em>OttO</em>: The orchestrator and runtime manager</li>
<li><em>Gardner</em>: The watering application.</li>
</ul>
<p>If you’re looking for a clean, composable way to manage embedded
systems or smart devices — Go gives you type safety, concurrency, and
simplicity out of the box.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/rustyeddy/otto">OttO GitHub Repository</a></li>
<li><a href="https://github.com/rustyeddy/devices">Devices GitHub Repository</a></li>
<li><a href="https://github.com/rustyeddy/gardener">Gardener</a></li>
<li><a href="https://RustyEddy.com">RustyEddy.com</a></li>
</ul>
<blockquote>
<p>Rusty Eddy builds open software for embedded systems and IoT. Follow
along at RustyEddy.com or on GitHub @rustyeddy .</p>
</blockquote>

	</article>
    </div>
    <div class="col"></div>
</div>
</div>

    </div><footer id="footer" class="container-fluid footer small-text pt-4 border-top">
  <section class="row">
    <div class="col"></div>
    <div class="col text-right">
      <div class="address">419 Main St. #439</div>
      <div class="city">Huntington Beach, CA. 92648</div>
    </div>
    <div class="col-3 text-center">
      <div>
        Last update ~
        
	
        Sunday, Nov 2, 2025
	
        
      </div>
      <div>site by <a href="/">Eddy Consulting, LLC.</a> ~ &#xA9; 2008 to 2024 </div>
    </div>
    <div class="col">
      <div class="text-left">
	<div class="phone">(714) 362-5402</div>
	<a href="https://github.com/rustyeddy">github</a> .
	<a href="https://twitter.com/rustyeddy">twitter</a> .
	<a href="https://linkedin.com/rustyeddy">linkedin</a><br/>	    
      </div>
    </div>
    <div class="col"></div>
  </section>
</footer>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-19940083-13"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  </body>
</html>
